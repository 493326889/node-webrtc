<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>webrtc</title>
</head>

<body>
	<div class="remote">
		<video></video>
	</div>
	<script>
		var host = '127.0.0.1';
		var bridge = host + ':9001';
		var ws = new WebSocket("ws://" + bridge);
		var pc = new window.RTCPeerConnection();
		var remoteVideo = document.querySelector('div#remote video');
		
		ws.onmessage = function (event) {
			var data = JSON.parse(event.data);
			switch(data.type){
				case 'answer':
					console.log('remoteSDP',data);
					setRemoteSDP(data);
					break;
				case 'cadidate':
					console.log('remoteCandidate',data.candidate);
					setRemoteCadidate(data.candidate);
					break;
				default:
					console.log('not match');
					break;
			}
		}

		//创建ICE处理
		pc.onicecandidate=function(event){
			if(event.candidate){
				console.log('candidate',event.candidate);
				ws.send(JSON.stringify({
					type: 'candidate',
					candidate: event.candidate
				}));
			}
		}

		pc.onontrack = function(e){
  			if (remoteVideo.srcObject !== e.streams[0]) {
    			remoteVideo.srcObject = e.streams[0];
    			trace('Received remote stream');
  			}
		}

		var offerOptions = {
			offerToReceiveAudio: 1,
			offerToReceiveVideo: 1
		};

		function createOffer() {
			var offer = pc.createOffer(
				offerOptions
			).then(
				setLocalSDP,
				doHandleError
			);
		}

		function setLocalSDP(desc) {
			pc.setLocalDescription(desc).then(
				doSendOffer(desc),
				doHandleError
			)
		}

		function setRemoteSDP(desc) {
			pc.setRemoteDescription(desc).then(
				doWaitForDataChanel,
				doHandleError
			)
		}

		function doSendOffer(offer) {
			console.log('sdp', offer.sdp);
			ws.send(JSON.stringify({
				'type': offer.type,
				'sdp': offer.sdp
			}));
		}

		//设置远程ICE候选路径
		function setRemoteCadidate(candidate){
			return	pc.addIceCandidate(new RTCIceCandidate(candidate));
		}

		function doWaitForDataChanel() {
			console.log('wait data chanel')
		}

		function doHandleError(err) {
			console.log(err);
		}

		ws.onopen=function(){
			createOffer();
		};
	</script>
	test webrtc
</body>

</html>